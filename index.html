<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>ZfP Vorf√§lle + Themen ¬∑ Komplett ¬∑ Supabase Sync</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #f5f5f7;
            --bg-secondary: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #334155;
            --border-color: #cbd5e1;
            --card-bg: #ffffff;
            --header-gradient: linear-gradient(135deg, #003366 0%, #1a4d8c 100%);
            --shadow-color: rgba(0,51,102,0.2);
            --input-bg: #ffffff;
            --badge-category-bg: #dbeafe;
            --badge-method-bg: #ede9fe;
            --badge-open-bg: #bbf7d0;
            --badge-closed-bg: #fecaca;
            --badge-long-bg: #dbeafe;
            --badge-short-bg: #fef3c7;
            --badge-digital-bg: #ede9fe;
            --badge-opt-bg: #d1fae5;
            --hover-bg: #f1f5f9;
            --btn-primary: #003366;
            --btn-primary-hover: #002244;
            --btn-success: #059669;
            --btn-success-hover: #047857;
            --btn-danger: #dc2626;
            --btn-danger-hover: #b91c1c;
            --btn-warning: #d97706;
            --btn-warning-hover: #b45309;
            --btn-reopen: #4f46e5;
            --btn-reopen-hover: #4338ca;
            --link-color: #2563eb;
            --text-on-badge: #0f172a;
            --kw-group-bg: #e2e8f0;
        }

        [data-theme="dark"] {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1e1e1e;
            --text-primary: #ffffff;
            --text-secondary: #e0e0e0;
            --border-color: #4a4a4a;
            --card-bg: #2a2a2a;
            --header-gradient: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            --shadow-color: rgba(0,0,0,0.5);
            --input-bg: #2d2d2d;
            --badge-category-bg: #1e3a8a;
            --badge-method-bg: #5b21b6;
            --badge-open-bg: #065f46;
            --badge-closed-bg: #991b1b;
            --badge-long-bg: #1e3a8a;
            --badge-short-bg: #92400e;
            --badge-digital-bg: #5b21b6;
            --badge-opt-bg: #065f46;
            --hover-bg: #374151;
            --btn-primary: #3b82f6;
            --btn-primary-hover: #2563eb;
            --btn-success: #10b981;
            --btn-success-hover: #059669;
            --btn-danger: #ef4444;
            --btn-danger-hover: #dc2626;
            --btn-warning: #f59e0b;
            --btn-warning-hover: #d97706;
            --btn-reopen: #6366f1;
            --btn-reopen-hover: #4f46e5;
            --link-color: #60a5fa;
            --text-on-badge: #ffffff;
            --kw-group-bg: #2d3748;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
            position: relative;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .theme-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 50px;
            padding: 12px;
            cursor: pointer;
            box-shadow: 0 4px 12px var(--shadow-color);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            width: 50px;
            height: 50px;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }

        .theme-toggle i {
            font-size: 24px;
            color: var(--text-primary);
        }

        .app-header {
            background: var(--header-gradient);
            color: white;
            padding: 25px;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 4px 20px var(--shadow-color);
        }

        .app-header h1 {
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }

        .app-header h1 i {
            font-size: 28px;
        }

        .app-header .subtitle {
            margin-top: 8px;
            opacity: 0.9;
            font-size: 15px;
            color: rgba(255,255,255,0.9);
        }

        /* Haupt-Tab Navigation */
        .main-tab-navigation {
            display: flex;
            gap: 10px;
            padding: 0 20px;
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--border-color);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            white-space: nowrap;
        }

        .main-tab-navigation::-webkit-scrollbar {
            display: none;
        }

        .main-tab-button {
            padding: 15px 25px;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .main-tab-button i {
            font-size: 18px;
        }

        .main-tab-button:hover {
            color: var(--text-primary);
        }

        .main-tab-button.active {
            color: var(--btn-primary);
            border-bottom-color: var(--btn-primary);
        }

        .main-tab-content {
            display: none;
            background: var(--bg-secondary);
            border-radius: 0 0 20px 20px;
            box-shadow: 0 10px 30px var(--shadow-color);
            padding: 30px;
        }

        .main-tab-content.active {
            display: block;
        }

        /* Unter-Tab Navigation - GETAUSCHT: Jetzt ist Liste zuerst, dann Neuer Vorfall */
        .sub-tab-navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 1px solid var(--border-color);
        }

        .sub-tab-button {
            padding: 12px 20px;
            background: none;
            border: none;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border-bottom: 3px solid transparent;
        }

        .sub-tab-button.active {
            color: var(--btn-primary);
            border-bottom-color: var(--btn-primary);
        }

        .sub-tab-content {
            display: none;
        }

        .sub-tab-content.active {
            display: block;
        }

        /* Form Styles */
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1 1 calc(50% - 10px);
            min-width: 250px;
            margin-bottom: 16px;
        }

        .form-group.full-width {
            flex: 0 0 100%;
            width: 100%;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        label i {
            margin-right: 6px;
            color: var(--btn-primary);
            font-size: 14px;
        }

        input, select, textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.2s;
            background: var(--input-bg);
            color: var(--text-primary);
            font-family: inherit;
            -webkit-appearance: none;
            appearance: none;
        }

        select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23334155' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 18px;
            padding-right: 45px;
        }

        [data-theme="dark"] select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--btn-primary);
            box-shadow: 0 0 0 4px rgba(59,130,246,0.3);
        }

        .filter-select {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 16px;
            background: var(--input-bg);
            color: var(--text-primary);
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23334155' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 18px;
            padding-right: 45px;
        }

        [data-theme="dark"] .filter-select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        }

        .btn {
            padding: 14px 25px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            width: 100%;
            -webkit-tap-highlight-color: transparent;
            color: var(--text-primary);
        }

        .btn-primary {
            background: var(--btn-primary);
            color: white;
            border: none;
        }

        .btn-primary:hover {
            background: var(--btn-primary-hover);
        }

        .btn-success {
            background: var(--btn-success);
            color: white;
            border: none;
        }

        .btn-success:hover {
            background: var(--btn-success-hover);
        }

        .btn-warning {
            background: var(--btn-warning);
            color: white;
            border: none;
        }

        .btn-warning:hover {
            background: var(--btn-warning-hover);
        }

        .btn-danger {
            background: var(--btn-danger);
            color: white;
            border: none;
        }

        .btn-danger:hover {
            background: var(--btn-danger-hover);
        }

        .btn-reopen {
            background: var(--btn-reopen);
            color: white;
            border: none;
        }

        .btn-reopen:hover {
            background: var(--btn-reopen-hover);
        }

        .btn-upload {
            background: var(--hover-bg);
            border: 2px dashed var(--border-color);
            justify-content: center;
            color: var(--text-primary);
            padding: 16px;
        }

        .btn-upload:hover {
            background: var(--bg-secondary);
        }

        .btn-submit {
            background: var(--btn-success);
            color: white;
            border: none;
            padding: 16px;
            font-size: 18px;
            width: 100%;
        }

        .btn-submit:hover {
            background: var(--btn-success-hover);
        }

        .image-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .image-preview-item {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            aspect-ratio: 1;
            background: var(--hover-bg);
            border: 2px solid var(--border-color);
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview-item .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.7);
            border: none;
            border-radius: 50%;
            width: 26px;
            height: 26px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            padding: 0;
            line-height: 1;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--btn-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message, .error-message {
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 12px;
            font-size: 16px;
            font-weight: 500;
        }

        .success-message {
            background: var(--btn-success);
            color: white;
        }

        .error-message {
            background: var(--btn-danger);
            color: white;
        }

        .list-header {
            margin-bottom: 25px;
        }

        .list-title {
            font-size: 22px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        .filter-section {
            display: flex;
            flex-direction: row;
            gap: 15px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 2;
            min-width: 250px;
            display: flex;
            align-items: center;
            background: var(--input-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 0 16px;
        }

        .search-box i {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .search-box input {
            border: none;
            padding: 14px 10px;
            width: 100%;
            outline: none;
            font-size: 16px;
            background: transparent;
            color: var(--text-primary);
        }

        .kw-group {
            margin-bottom: 30px;
        }

        .kw-header {
            background: var(--kw-group-bg);
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-left: 5px solid var(--btn-primary);
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1.2em;
        }

        .kw-header i {
            color: var(--btn-primary);
            font-size: 1.3em;
        }

        .kw-count {
            margin-left: auto;
            background: var(--bg-secondary);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .incident-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
        }

        .incident-card {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.2s;
        }

        .incident-card:hover {
            border-color: var(--btn-primary);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px var(--shadow-color);
        }

        .card-header {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .card-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            color: var(--text-on-badge);
        }

        .badge-category {
            background: var(--badge-category-bg);
        }

        .badge-method {
            background: var(--badge-method-bg);
        }

        .badge-status {
            background: var(--badge-open-bg);
        }

        .badge-status.closed {
            background: var(--badge-closed-bg);
        }

        .badge-long { background: var(--badge-long-bg); }
        .badge-short { background: var(--badge-short-bg); }
        .badge-digital { background: var(--badge-digital-bg); }
        .badge-opt { background: var(--badge-opt-bg); }

        .card-date {
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .card-content {
            margin-bottom: 15px;
            cursor: pointer;
        }

        .info-row {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            font-size: 15px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .info-label {
            font-weight: 600;
            color: var(--text-secondary);
            min-width: 100px;
            font-size: 14px;
        }

        .info-value {
            color: var(--text-primary);
            flex: 1;
            font-size: 14px;
        }

        .card-preview {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 12px;
        }

        .preview-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid var(--border-color);
        }

        .card-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            flex-wrap: wrap;
        }

        .action-button {
            flex: 1;
            min-width: 80px;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.2s;
        }

        .action-button:active {
            transform: scale(0.96);
        }

        .action-button.view {
            background: var(--hover-bg);
            color: var(--text-primary);
        }

        .action-button.edit {
            background: var(--btn-warning);
            color: white;
        }

        .action-button.close {
            background: var(--btn-success);
            color: white;
        }

        .action-button.reopen {
            background: var(--btn-reopen);
            color: white;
        }

        .action-button.delete {
            background: var(--btn-danger);
            color: white;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 30px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 24px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
        }

        .modal-header {
            padding: 25px;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            z-index: 10;
        }

        .modal-header h2 {
            font-size: 22px;
            color: var(--text-primary);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 5px 15px;
        }

        .close-modal:hover {
            color: var(--btn-primary);
        }

        .modal-body {
            padding: 25px;
        }

        .modal-footer {
            padding: 25px;
            border-top: 2px solid var(--border-color);
            display: flex;
            gap: 15px;
            position: sticky;
            bottom: 0;
            background: var(--bg-secondary);
            flex-wrap: wrap;
        }

        .modal-footer .btn {
            flex: 1;
            min-width: 120px;
        }

        .detail-section {
            margin-bottom: 25px;
        }

        .detail-section h3 {
            font-size: 18px;
            color: var(--btn-primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .detail-item {
            background: var(--hover-bg);
            padding: 15px;
            border-radius: 12px;
        }

        .detail-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .detail-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .gallery-image {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 12px;
            cursor: pointer;
            border: 2px solid var(--border-color);
        }

        .gallery-image:hover {
            border-color: var(--btn-primary);
        }

        .confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            padding: 20px;
        }

        .confirm-modal.active {
            display: flex;
        }

        .confirm-content {
            background: var(--bg-secondary);
            border-radius: 24px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .confirm-content h3 {
            font-size: 22px;
            color: var(--text-primary);
            margin-bottom: 15px;
        }

        .confirm-content p {
            color: var(--text-secondary);
            margin-bottom: 25px;
            font-size: 16px;
        }

        .confirm-buttons {
            display: flex;
            gap: 15px;
        }

        .confirm-buttons .btn {
            flex: 1;
        }

        .password-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 4000;
            padding: 20px;
        }

        .password-modal.active {
            display: flex;
        }

        .password-content {
            background: var(--bg-secondary);
            border-radius: 24px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
        }

        .password-content h3 {
            font-size: 22px;
            color: var(--text-primary);
            margin-bottom: 15px;
        }

        .password-content p {
            color: var(--text-secondary);
            margin-bottom: 20px;
            font-size: 14px;
        }

        .password-input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 20px;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .password-buttons {
            display: flex;
            gap: 15px;
        }

        .password-error {
            color: var(--btn-danger);
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }

        .password-error.show {
            display: block;
        }

        .fas, .far {
            font-size: 16px;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .form-group {
                flex: 0 0 100%;
            }
            
            .filter-section {
                flex-direction: column;
            }
            
            .incident-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-footer {
                flex-direction: column;
            }
            
            .modal-footer .btn {
                width: 100%;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body data-theme="light">
    <div class="theme-toggle" onclick="toggleTheme()">
        <i class="fas fa-moon" id="themeIcon"></i>
    </div>

    <div class="app-container">
        <div class="app-header">
            <h1>
                <i class="fas fa-hard-hat"></i>
                ZfP Vorf√§lle & Themenmanagement
            </h1>
            <div class="subtitle">
                <i class="fas fa-clipboard-check"></i>
                Vorf√§lle + Langfristige/Kurzfristige Themen ¬∑ L√∂schen ENDG√úLTIG FIX
            </div>
        </div>

        <!-- Haupt-Tab Navigation -->
        <div class="main-tab-navigation">
            <button class="main-tab-button active" onclick="switchMainTab('vorfaelle')">
                <i class="fas fa-exclamation-triangle"></i>
                Vorf√§lle
            </button>
            <button class="main-tab-button" onclick="switchMainTab('themen')">
                <i class="fas fa-tasks"></i>
                Langfristige / Kurzfristige Themen
            </button>
        </div>

        <!-- Haupt-Tab: Vorf√§lle -->
        <div id="main-tab-vorfaelle" class="main-tab-content active">
            <div class="sub-tab-navigation">
                <button class="sub-tab-button active" onclick="switchSubTab('list')">
                    <i class="fas fa-list"></i>
                    Vorf√§lle Liste
                </button>
                <button class="sub-tab-button" onclick="switchSubTab('new')">
                    <i class="fas fa-plus-circle"></i>
                    Neuer Vorfall
                </button>
            </div>

            <div id="subtab-list" class="sub-tab-content active">
                <div class="list-header">
                    <div class="list-title">
                        <i class="fas fa-calendar-alt"></i>
                        Vorf√§lle gruppiert nach Kalenderwochen
                    </div>
                    <div class="filter-section">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchInput" placeholder="Suchen..." onkeyup="filterIncidents()">
                        </div>
                        <select class="filter-select" id="categoryFilter" onchange="filterIncidents()">
                            <option value="">Alle Kategorien</option>
                            <option value="ZfP Anlage">ZfP Anlage</option>
                            <option value="ZfP Pr√ºfung">ZfP Pr√ºfung</option>
                        </select>
                        <select class="filter-select" id="statusFilter" onchange="filterIncidents()">
                            <option value="">Alle Status</option>
                            <option value="open">Offen</option>
                            <option value="closed">Geschlossen</option>
                        </select>
                    </div>
                </div>

                <div id="incidentList" class="incident-list-container">
                    <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                        <i class="fas fa-spinner fa-spin" style="font-size: 48px; margin-bottom: 20px;"></i>
                        <p style="font-size: 18px;">Lade Vorf√§lle...</p>
                    </div>
                </div>
            </div>

            <div id="subtab-new" class="sub-tab-content">
                <div class="success-message" id="successMessage">
                    <i class="fas fa-check-circle"></i>
                    <span>Vorfall erfolgreich dokumentiert!</span>
                </div>
                <div class="error-message" id="errorMessage">
                    <i class="fas fa-exclamation-circle"></i>
                    <span id="errorText"></span>
                </div>

                <form id="incidentForm" onsubmit="event.preventDefault(); saveIncident();">
                    <input type="hidden" id="editId" value="">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label><i class="fas fa-tag"></i> Kategorie *</label>
                            <select id="category" required onchange="updateCategoryFields()">
                                <option value="">Bitte w√§hlen...</option>
                                <option value="ZfP Anlage">üîß ZfP Anlage</option>
                                <option value="ZfP Pr√ºfung">üîç ZfP Pr√ºfung</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-building"></i> Prozess *</label>
                            <select id="process" required>
                                <option value="">Bitte w√§hlen...</option>
                                <option value="Seitenschleifen">Seitenschleifen</option>
                                <option value="Centerless Schleifen">Centerless Schleifen</option>
                                <option value="Laufbahn Schleifen">Laufbahn Schleifen</option>
                                <option value="Pr√ºfung">Pr√ºfung</option>
                                <option value="Sonstiges">Sonstiges</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label><i class="fas fa-cubes"></i> Segment *</label>
                            <select id="segment" required>
                                <option value="">Bitte w√§hlen...</option>
                                <option value="Segment 4">Segment 4</option>
                                <option value="Segment 6">Segment 6</option>
                                <option value="Segment 11">Segment 11</option>
                                <option value="Segment 12">Segment 12</option>
                                <option value="Segment 14">Segment 14</option>
                                <option value="Segment 15">Segment 15</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-flask"></i> Pr√ºfverfahren *</label>
                            <select id="inspectionMethod" required>
                                <option value="">Bitte w√§hlen...</option>
                                <option value="MT">Magnetpulverpr√ºfung (MT)</option>
                                <option value="UT">Ultraschallpr√ºfung (UT)</option>
                                <option value="VT">Sichtpr√ºfung (VT)</option>
                                <option value="RT">Durchstrahlungspr√ºfung (RT)</option>
                                <option value="PT">Eindringpr√ºfung (PT)</option>
                                <option value="ET">Wirbelstrompr√ºfung (ET)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group" id="machineNumberGroup" style="display: none;">
                        <label><i class="fas fa-industry"></i> Maschinennummer *</label>
                        <input type="text" id="machineNumber" placeholder="z.B. M-4711">
                    </div>

                    <div class="form-group" id="orderNumberGroup" style="display: none;">
                        <label><i class="fas fa-hashtag"></i> Auftragsnummer *</label>
                        <input type="text" id="orderNumber" placeholder="z.B. A-2024-001">
                    </div>

                    <div id="categorySpecificFields"></div>

                    <div class="form-group full-width">
                        <label><i class="fas fa-exclamation-triangle"></i> Problem / Beschreibung *</label>
                        <textarea id="problemDescription" rows="4" required placeholder="Beschreiben Sie das Problem..."></textarea>
                    </div>

                    <div class="form-group full-width">
                        <label><i class="fas fa-images"></i> Bilder</label>
                        <button type="button" class="btn btn-upload" id="uploadButton">
                            <i class="fas fa-cloud-upload-alt"></i> Bilder ausw√§hlen
                        </button>
                        <input type="file" id="imageUpload" accept="image/*" multiple style="display: none;">
                        <div class="image-preview-grid" id="imagePreview"></div>
                    </div>

                    <div class="submit-section">
                        <button type="submit" class="btn btn-submit" id="submitButton">
                            <i class="fas fa-save"></i> Vorfall dokumentieren
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Haupt-Tab: Themen (unver√§ndert) -->
        <div id="main-tab-themen" class="main-tab-content">
            <div class="sub-tab-navigation">
                <button class="sub-tab-button active" onclick="switchThemesTab('langfristig')">
                    <i class="fas fa-calendar-alt"></i> Langfristige Themen
                </button>
                <button class="sub-tab-button" onclick="switchThemesTab('kurzfristig')">
                    <i class="fas fa-hourglass-half"></i> Kurzfristige Themen
                </button>
                <button class="sub-tab-button" onclick="switchThemesTab('neu')">
                    <i class="fas fa-plus-circle"></i> Neues Thema
                </button>
            </div>

            <div id="themes-langfristig" class="sub-tab-content active">
                <div class="filter-section">
                    <select class="filter-select" id="filterLangCategory" onchange="filterLongTerm()">
                        <option value="">Alle Kategorien</option>
                        <option value="ZfP Anlage">ZfP Anlage</option>
                        <option value="ZfP Pr√ºfung">ZfP Pr√ºfung</option>
                        <option value="Digitalisierung">Digitalisierung</option>
                        <option value="Pr√ºfprozessoptimierung">Pr√ºfprozessoptimierung</option>
                    </select>
                    <select class="filter-select" id="filterLangStatus" onchange="filterLongTerm()">
                        <option value="">Alle Status</option>
                        <option value="open">Offen</option>
                        <option value="closed">Geschlossen</option>
                    </select>
                </div>
                <div id="langfristigList" class="incident-list-container">
                    <div style="text-align: center; padding: 60px; color: var(--text-secondary);">
                        <i class="fas fa-spinner fa-spin" style="font-size: 48px;"></i>
                        <p>Lade langfristige Themen...</p>
                    </div>
                </div>
            </div>

            <div id="themes-kurzfristig" class="sub-tab-content">
                <div class="filter-section">
                    <select class="filter-select" id="filterShortCategory" onchange="filterShortTerm()">
                        <option value="">Alle Kategorien</option>
                        <option value="ZfP Anlage">ZfP Anlage</option>
                        <option value="ZfP Pr√ºfung">ZfP Pr√ºfung</option>
                        <option value="Digitalisierung">Digitalisierung</option>
                        <option value="Pr√ºfprozessoptimierung">Pr√ºfprozessoptimierung</option>
                    </select>
                    <select class="filter-select" id="filterShortStatus" onchange="filterShortTerm()">
                        <option value="">Alle Status</option>
                        <option value="open">Offen</option>
                        <option value="closed">Geschlossen</option>
                    </select>
                </div>
                <div id="kurzfristigList" class="incident-list-container">
                    <div style="text-align: center; padding: 60px; color: var(--text-secondary);">
                        <i class="fas fa-spinner fa-spin" style="font-size: 48px;"></i>
                        <p>Lade kurzfristige Themen...</p>
                    </div>
                </div>
            </div>

            <div id="themes-neu" class="sub-tab-content">
                <div class="success-message" id="themeSuccessMessage"><i class="fas fa-check-circle"></i> <span>Gespeichert</span></div>
                <div class="error-message" id="themeErrorMessage"><i class="fas fa-exclamation-circle"></i> <span id="themeErrorText"></span></div>

                <form id="topicForm" onsubmit="event.preventDefault(); saveTopic();">
                    <input type="hidden" id="themeEditId" value="">
                    <div class="form-row">
                        <div class="form-group">
                            <label><i class="fas fa-clock"></i> Themenhorizont *</label>
                            <select id="horizon" required>
                                <option value="">Bitte w√§hlen...</option>
                                <option value="langfristig">üåø Langfristig</option>
                                <option value="kurzfristig">‚ö° Kurzfristig</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-tag"></i> Kategorie *</label>
                            <select id="themeCategory" required>
                                <option value="">Bitte w√§hlen...</option>
                                <option value="ZfP Anlage">üîß ZfP Anlage</option>
                                <option value="ZfP Pr√ºfung">üîç ZfP Pr√ºfung</option>
                                <option value="Digitalisierung">üíª Digitalisierung</option>
                                <option value="Pr√ºfprozessoptimierung">‚öôÔ∏è Pr√ºfprozessoptimierung</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label><i class="fas fa-heading"></i> Titel / Thema *</label>
                            <input type="text" id="title" placeholder="Kurze Bezeichnung" required>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-building"></i> Prozess (optional)</label>
                            <input type="text" id="themeProcess" placeholder="z.B. Seitenschleifen">
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label><i class="fas fa-align-left"></i> Beschreibung *</label>
                        <textarea id="description" rows="4" required placeholder="Detaillierte Beschreibung..."></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label><i class="fas fa-tasks"></i> Ma√ünahmen / n√§chste Schritte</label>
                        <textarea id="measures" rows="3" placeholder="Geplante Ma√ünahmen, Verantwortlichkeiten ..."></textarea>
                    </div>
                    <div class="submit-section">
                        <button type="submit" class="btn btn-submit" id="themeSubmitBtn"><i class="fas fa-save"></i> Thema speichern</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- MODAL F√úR DETAILS -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle"><i class="fas fa-file-alt"></i> Details</h2>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer" id="modalFooter"></div>
        </div>
    </div>

    <div class="confirm-modal" id="confirmModal">
        <div class="confirm-content">
            <h3 id="confirmTitle">Best√§tigung</h3>
            <p id="confirmMessage">Sind Sie sicher?</p>
            <div class="confirm-buttons">
                <button class="btn btn-danger" id="confirmYesBtn">Ja</button>
                <button class="btn" onclick="closeConfirmModal()">Nein</button>
            </div>
        </div>
    </div>

    <div class="password-modal" id="passwordModal">
        <div class="password-content">
            <h3><i class="fas fa-lock"></i> Passwort erforderlich</h3>
            <p>Bitte geben Sie das Supervisor-Passwort ein.</p>
            <input type="password" id="passwordInput" class="password-input" placeholder="Passwort">
            <div class="password-error" id="passwordError">Falsches Passwort!</div>
            <div class="password-buttons">
                <button class="btn btn-danger" onclick="checkPasswordAndDelete()">
                    <i class="fas fa-trash"></i> L√∂schen
                </button>
                <button class="btn" onclick="closePasswordModal()">
                    <i class="fas fa-times"></i> Abbrechen
                </button>
            </div>
        </div>
    </div>

    <script>
        (function() {
            // Supabase Konfiguration
            const SUPABASE_URL = 'https://wqrynlgbspkjzxuxauvq.supabase.co';
            const SUPABASE_ANON_KEY = 'sb_publishable_jkkaIcAKxMhkXSdnJY1Oiw_U-xPWr68';
            
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            const SUPERVIOR_PASSWORD = 'Supervisor';

            // Globale Variablen
            let compressedImages = [];
            let existingImages = [];
            let allIncidents = [];
            let allTopics = [];
            let currentIncidentId = null;
            let currentTopicId = null;
            let pendingAction = null; // 'deleteIncident' oder 'deleteTopic'

            // Theme Toggle
            window.toggleTheme = function() {
                const body = document.body;
                const themeIcon = document.getElementById('themeIcon');
                
                if (body.getAttribute('data-theme') === 'light') {
                    body.setAttribute('data-theme', 'dark');
                    themeIcon.className = 'fas fa-sun';
                    localStorage.setItem('zfp-theme-preference', 'dark');
                } else {
                    body.setAttribute('data-theme', 'light');
                    themeIcon.className = 'fas fa-moon';
                    localStorage.setItem('zfp-theme-preference', 'light');
                }
            };

            const savedTheme = localStorage.getItem('zfp-theme-preference');
            if (savedTheme) {
                document.body.setAttribute('data-theme', savedTheme);
                document.getElementById('themeIcon').className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }

            // Haupt-Tab Umschaltung
            window.switchMainTab = function(tab) {
                document.querySelectorAll('.main-tab-button').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.main-tab-content').forEach(c => c.classList.remove('active'));
                
                if (tab === 'vorfaelle') {
                    document.querySelectorAll('.main-tab-button')[0].classList.add('active');
                    document.getElementById('main-tab-vorfaelle').classList.add('active');
                } else {
                    document.querySelectorAll('.main-tab-button')[1].classList.add('active');
                    document.getElementById('main-tab-themen').classList.add('active');
                    loadTopics();
                }
            };

            // Unter-Tab f√ºr Vorf√§lle - Jetzt ist Liste standardm√§√üig aktiv
            window.switchSubTab = function(tab) {
                document.querySelectorAll('#main-tab-vorfaelle .sub-tab-button').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('#main-tab-vorfaelle .sub-tab-content').forEach(c => c.classList.remove('active'));
                
                if (tab === 'list') {
                    document.querySelectorAll('#main-tab-vorfaelle .sub-tab-button')[0].classList.add('active');
                    document.getElementById('subtab-list').classList.add('active');
                    loadIncidents();
                } else if (tab === 'new') {
                    document.querySelectorAll('#main-tab-vorfaelle .sub-tab-button')[1].classList.add('active');
                    document.getElementById('subtab-new').classList.add('active');
                }
            };

            // Themen-Tab Umschaltung (unver√§ndert)
            window.switchThemesTab = function(tab) {
                document.querySelectorAll('#main-tab-themen .sub-tab-button').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('#main-tab-themen .sub-tab-content').forEach(c => c.classList.remove('active'));
                
                if (tab === 'langfristig') {
                    document.querySelectorAll('#main-tab-themen .sub-tab-button')[0].classList.add('active');
                    document.getElementById('themes-langfristig').classList.add('active');
                    filterLongTerm();
                } else if (tab === 'kurzfristig') {
                    document.querySelectorAll('#main-tab-themen .sub-tab-button')[1].classList.add('active');
                    document.getElementById('themes-kurzfristig').classList.add('active');
                    filterShortTerm();
                } else if (tab === 'neu') {
                    document.querySelectorAll('#main-tab-themen .sub-tab-button')[2].classList.add('active');
                    document.getElementById('themes-neu').classList.add('active');
                    document.getElementById('themeEditId').value = '';
                    document.getElementById('topicForm').reset();
                }
            };

            // ----- VORF√ÑLLE -----
            
            window.updateCategoryFields = function() {
                const category = document.getElementById('category').value;
                const categorySpecificFields = document.getElementById('categorySpecificFields');
                const machineGroup = document.getElementById('machineNumberGroup');
                const orderGroup = document.getElementById('orderNumberGroup');
                
                categorySpecificFields.innerHTML = '';
                
                if (category === 'ZfP Pr√ºfung') {
                    machineGroup.style.display = 'none';
                    orderGroup.style.display = 'block';
                    document.getElementById('machineNumber').required = false;
                    document.getElementById('orderNumber').required = true;
                    
                    categorySpecificFields.innerHTML = `
                        <div class="form-group">
                            <label><i class="fas fa-exclamation-circle"></i> Fehlerbild *</label>
                            <select id="errorType" required>
                                <option value="">Bitte w√§hlen...</option>
                                <option value="Schleifbrand">Schleifbrand</option>
                                <option value="Risse">Risse</option>
                                <option value="Sonstiges">Sonstiges</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-cog"></i> Type / Modell</label>
                            <input type="text" id="type" placeholder="z.B. Typ X-2000">
                        </div>
                    `;
                } else if (category === 'ZfP Anlage') {
                    machineGroup.style.display = 'block';
                    orderGroup.style.display = 'none';
                    document.getElementById('machineNumber').required = true;
                    document.getElementById('orderNumber').required = false;
                    
                    categorySpecificFields.innerHTML = `
                        <div class="form-group">
                            <label><i class="fas fa-exclamation-circle"></i> Fehlerart *</label>
                            <select id="errorType" required>
                                <option value="">Bitte w√§hlen...</option>
                                <option value="St√∂rung">St√∂rung</option>
                                <option value="Wartung">Wartung</option>
                                <option value="Defekt">Defekt</option>
                                <option value="Sonstiges">Sonstiges</option>
                            </select>
                        </div>
                    `;
                } else {
                    machineGroup.style.display = 'none';
                    orderGroup.style.display = 'none';
                    document.getElementById('machineNumber').required = false;
                    document.getElementById('orderNumber').required = false;
                }
            };

            document.getElementById('uploadButton')?.addEventListener('click', function() {
                document.getElementById('imageUpload').click();
            });

            document.getElementById('imageUpload')?.addEventListener('change', async function(e) {
                const files = Array.from(e.target.files);
                
                for (const file of files) {
                    try {
                        const compressedFile = await compressImage(file);
                        compressedImages.push(compressedFile);
                        
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            addImagePreview(e.target.result, false);
                        };
                        reader.readAsDataURL(compressedFile);
                    } catch (error) {
                        console.error('Fehler bei der Bildkomprimierung:', error);
                        showError('Fehler bei der Bildverarbeitung');
                    }
                }
            });

            async function compressImage(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (e) => {
                        const img = new Image();
                        img.src = e.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;
                            
                            const maxWidth = 1024;
                            if (width > maxWidth) {
                                height = Math.round((height * maxWidth) / width);
                                width = maxWidth;
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            canvas.toBlob((blob) => {
                                const compressedFile = new File([blob], file.name.replace(/\.[^/.]+$/, ".jpg"), {
                                    type: 'image/jpeg',
                                    lastModified: Date.now()
                                });
                                resolve(compressedFile);
                            }, 'image/jpeg', 0.8);
                        };
                        img.onerror = reject;
                    };
                    reader.onerror = reject;
                });
            }

            function addImagePreview(imageData, isExisting = false) {
                const previewGrid = document.getElementById('imagePreview');
                const previewItem = document.createElement('div');
                previewItem.className = 'image-preview-item';
                
                previewItem.innerHTML = `
                    <img src="${imageData}" alt="Preview">
                    <button class="remove-image" onclick="removeImage(this, ${isExisting})">√ó</button>
                `;
                
                previewGrid.appendChild(previewItem);
            }

            window.removeImage = function(button, isExisting = false) {
                const previewItem = button.parentElement;
                const index = Array.from(previewItem.parentElement.children).indexOf(previewItem);
                
                if (isExisting) {
                    existingImages.splice(index, 1);
                } else {
                    compressedImages.splice(index, 1);
                }
                
                previewItem.remove();
            };

            window.saveIncident = async function() {
                const editId = document.getElementById('editId').value;
                const category = document.getElementById('category').value;
                const machineNumber = document.getElementById('machineNumber').value;
                const orderNumber = document.getElementById('orderNumber').value;
                const process = document.getElementById('process').value;
                const segment = document.getElementById('segment').value;
                const inspectionMethod = document.getElementById('inspectionMethod').value;
                const problemDescription = document.getElementById('problemDescription').value;

                if (!category || !process || !segment || !inspectionMethod || !problemDescription) {
                    showError('Bitte f√ºllen Sie alle Pflichtfelder aus.');
                    return;
                }

                if (category === 'ZfP Anlage' && !machineNumber) {
                    showError('Bitte geben Sie eine Maschinennummer ein.');
                    return;
                }

                if (category === 'ZfP Pr√ºfung' && !orderNumber) {
                    showError('Bitte geben Sie eine Auftragsnummer ein.');
                    return;
                }

                const errorType = document.getElementById('errorType');
                if (errorType && !errorType.value) {
                    showError('Bitte w√§hlen Sie ein Fehlerbild / eine Fehlerart aus.');
                    return;
                }

                document.getElementById('loadingOverlay').style.display = 'flex';
                hideError();
                
                try {
                    let imageUrls = [...existingImages];
                    
                    for (const image of compressedImages) {
                        const fileName = `incident_${Date.now()}_${Math.random().toString(36).substring(7)}.jpg`;
                        
                        const { data: uploadData, error: uploadError } = await supabase.storage
                            .from('incident_images')
                            .upload(fileName, image);
                        
                        if (uploadError) {
                            console.error('Upload Error:', uploadError);
                            throw new Error('Fehler beim Bild-Upload: ' + uploadError.message);
                        }
                        
                        const { data: { publicUrl } } = supabase.storage
                            .from('incident_images')
                            .getPublicUrl(fileName);
                        
                        imageUrls.push(publicUrl);
                    }
                    
                    const formData = {
                        category: category,
                        process: process,
                        segment: segment,
                        inspection_method: inspectionMethod,
                        problem_description: problemDescription,
                        image_urls: imageUrls.length > 0 ? imageUrls : null,
                    };
                    
                    if (category === 'ZfP Anlage') {
                        formData.machine_number = machineNumber;
                        formData.order_number = null;
                    } else if (category === 'ZfP Pr√ºfung') {
                        formData.order_number = orderNumber;
                        formData.machine_number = null;
                    }
                    
                    if (category === 'ZfP Pr√ºfung') {
                        formData.error_type = document.getElementById('errorType').value;
                        const typeInput = document.getElementById('type');
                        if (typeInput && typeInput.value) {
                            formData.type = typeInput.value;
                        }
                    } else if (category === 'ZfP Anlage') {
                        formData.error_type = document.getElementById('errorType').value;
                    }
                    
                    let result;
                    
                    if (editId) {
                        result = await supabase
                            .from('incidents')
                            .update(formData)
                            .eq('id', editId);
                        
                        if (result.error) throw result.error;
                        showSuccess('Vorfall erfolgreich aktualisiert!');
                    } else {
                        formData.status = 'open';
                        formData.created_at = new Date().toISOString();
                        
                        result = await supabase
                            .from('incidents')
                            .insert([formData]);
                        
                        if (result.error) throw result.error;
                        showSuccess('Vorfall erfolgreich dokumentiert!');
                    }
                    
                    resetForm();
                    switchSubTab('list');
                    
                } catch (error) {
                    console.error('Fehler:', error);
                    showError(error.message);
                } finally {
                    document.getElementById('loadingOverlay').style.display = 'none';
                }
            };

            function resetForm() {
                document.getElementById('incidentForm').reset();
                document.getElementById('editId').value = '';
                document.getElementById('categorySpecificFields').innerHTML = '';
                document.getElementById('imagePreview').innerHTML = '';
                document.getElementById('machineNumberGroup').style.display = 'none';
                document.getElementById('orderNumberGroup').style.display = 'none';
                compressedImages = [];
                existingImages = [];
                document.getElementById('submitButton').innerHTML = '<i class="fas fa-save"></i> Vorfall dokumentieren';
            }

            function showError(message) {
                document.getElementById('errorText').textContent = message;
                document.getElementById('errorMessage').style.display = 'flex';
                setTimeout(() => {
                    document.getElementById('errorMessage').style.display = 'none';
                }, 5000);
            }

            function hideError() {
                document.getElementById('errorMessage').style.display = 'none';
            }

            function showSuccess(message) {
                document.getElementById('successMessage').querySelector('span').textContent = message;
                document.getElementById('successMessage').style.display = 'flex';
                setTimeout(() => {
                    document.getElementById('successMessage').style.display = 'none';
                }, 3000);
            }

            async function loadIncidents() {
                document.getElementById('loadingOverlay').style.display = 'flex';
                
                try {
                    const { data, error } = await supabase
                        .from('incidents')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    
                    allIncidents = data || [];
                    displayIncidents(allIncidents);
                } catch (error) {
                    console.error('Fehler beim Laden:', error);
                    document.getElementById('incidentList').innerHTML = `
                        <div style="text-align: center; padding: 50px; color: var(--btn-danger);">
                            <i class="fas fa-exclamation-circle" style="font-size: 48px; margin-bottom: 15px;"></i>
                            <p>Fehler beim Laden: ${error.message}</p>
                        </div>
                    `;
                } finally {
                    document.getElementById('loadingOverlay').style.display = 'none';
                }
            }

            function getCalendarWeekIncident(date) {
                const d = new Date(date);
                d.setHours(0, 0, 0, 0);
                d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
                const week1 = new Date(d.getFullYear(), 0, 4);
                const weekNumber = 1 + Math.round(((d - week1) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
                return `KW ${weekNumber} - ${d.getFullYear()}`;
            }

            function groupIncidentsByWeek(incidents) {
                const grouped = {};
                incidents.forEach(incident => {
                    const week = getCalendarWeekIncident(incident.created_at);
                    if (!grouped[week]) grouped[week] = [];
                    grouped[week].push(incident);
                });
                const sortedWeeks = Object.keys(grouped).sort((a, b) => {
                    const weekA = parseInt(a.split(' ')[1]);
                    const yearA = parseInt(a.split(' - ')[1]);
                    const weekB = parseInt(b.split(' ')[1]);
                    const yearB = parseInt(b.split(' - ')[1]);
                    if (yearA !== yearB) return yearB - yearA;
                    return weekB - weekA;
                });
                const sortedGrouped = {};
                sortedWeeks.forEach(week => { sortedGrouped[week] = grouped[week]; });
                return sortedGrouped;
            }

            function displayIncidents(incidents) {
                const container = document.getElementById('incidentList');
                if (incidents.length === 0) {
                    container.innerHTML = `<div style="text-align: center; padding: 60px; color: var(--text-secondary);"><i class="fas fa-folder-open" style="font-size: 64px; margin-bottom: 20px;"></i><p style="font-size: 18px;">Keine Vorf√§lle gefunden</p></div>`;
                    return;
                }
                const groupedIncidents = groupIncidentsByWeek(incidents);
                let html = '';
                for (const [week, weekIncidents] of Object.entries(groupedIncidents)) {
                    html += `<div class="kw-group"><div class="kw-header"><i class="fas fa-calendar-week"></i> ${week}<span class="kw-count">${weekIncidents.length} Vorf√§lle</span></div><div class="incident-grid">`;
                    weekIncidents.forEach(incident => {
                        const date = new Date(incident.created_at).toLocaleDateString('de-DE');
                        const categoryIcon = incident.category === 'ZfP Anlage' ? 'fa-industry' : 'fa-search';
                        const statusClass = incident.status === 'closed' ? 'closed' : '';
                        const statusIcon = incident.status === 'open' ? 'fa-hourglass-half' : 'fa-check-circle';
                        const statusText = incident.status === 'open' ? 'Offen' : 'Geschlossen';
                        
                        let numberDisplay = '';
                        if (incident.category === 'ZfP Anlage' && incident.machine_number) {
                            numberDisplay = `<div class="info-row"><span class="info-label"><i class="fas fa-industry"></i> Maschine:</span><span class="info-value">${incident.machine_number}</span></div>`;
                        } else if (incident.category === 'ZfP Pr√ºfung' && incident.order_number) {
                            numberDisplay = `<div class="info-row"><span class="info-label"><i class="fas fa-hashtag"></i> Auftrag:</span><span class="info-value">${incident.order_number}</span></div>`;
                        }
                        
                        html += `
                            <div class="incident-card">
                                <div class="card-header">
                                    <div class="card-badges">
                                        <span class="badge badge-category"><i class="fas ${categoryIcon}"></i> ${incident.category}</span>
                                        <span class="badge badge-method"><i class="fas fa-flask"></i> ${incident.inspection_method}</span>
                                        <span class="badge badge-status ${statusClass}"><i class="fas ${statusIcon}"></i> ${statusText}</span>
                                    </div>
                                    <div class="card-date"><i class="far fa-calendar-alt"></i> ${date}</div>
                                </div>
                                <div class="card-content" onclick="openIncident('${incident.id}')">
                                    ${numberDisplay}
                                    <div class="info-row"><span class="info-label"><i class="fas fa-building"></i> Prozess:</span><span class="info-value">${incident.process}</span></div>
                                    <div class="info-row"><span class="info-label"><i class="fas fa-exclamation"></i> Problem:</span><span class="info-value">${incident.problem_description.substring(0, 80)}${incident.problem_description.length > 80 ? '...' : ''}</span></div>
                                    <div class="card-preview">
                                        ${incident.image_urls && incident.image_urls.length > 0 ? 
                                            `<img src="${incident.image_urls[0]}" class="preview-image" alt="Preview" onclick="event.stopPropagation(); window.open('${incident.image_urls[0]}', '_blank')">` : 
                                            '<div style="width: 60px; height: 60px; background: var(--hover-bg); border-radius: 8px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-image" style="color: var(--text-secondary); font-size: 24px;"></i></div>'
                                        }
                                    </div>
                                </div>
                                <div class="card-actions">
                                    <button class="action-button view" onclick="openIncident('${incident.id}')"><i class="fas fa-eye"></i> Details</button>
                                    <button class="action-button edit" onclick="editIncident('${incident.id}')"><i class="fas fa-edit"></i> Edit</button>
                                    ${incident.status === 'open' ? 
                                        `<button class="action-button close" onclick="closeIncident('${incident.id}')"><i class="fas fa-check-circle"></i> Fertig</button>` : 
                                        `<button class="action-button reopen" onclick="reopenIncident('${incident.id}')"><i class="fas fa-undo-alt"></i> Wieder √∂ffnen</button>`}
                                    <button class="action-button delete" onclick="showPasswordModalForIncident('${incident.id}')"><i class="fas fa-trash"></i> L√∂schen</button>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div></div>';
                }
                container.innerHTML = html;
            }

            window.filterIncidents = function() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const categoryFilter = document.getElementById('categoryFilter').value;
                const statusFilter = document.getElementById('statusFilter').value;
                
                const filtered = allIncidents.filter(incident => {
                    const searchString = (incident.problem_description + ' ' + (incident.machine_number || '') + ' ' + (incident.order_number || '') + ' ' + (incident.process || '')).toLowerCase();
                    const matchesSearch = !searchTerm || searchString.includes(searchTerm);
                    const matchesCategory = !categoryFilter || incident.category === categoryFilter;
                    const matchesStatus = !statusFilter || incident.status === statusFilter;
                    return matchesSearch && matchesCategory && matchesStatus;
                });
                displayIncidents(filtered);
            };

            window.openIncident = async function(id) {
                document.getElementById('loadingOverlay').style.display = 'flex';
                try {
                    const { data, error } = await supabase.from('incidents').select('*').eq('id', id).single();
                    if (error) throw error;
                    currentIncidentId = id;
                    showIncidentDetails(data);
                } catch (error) {
                    showError('Fehler beim Laden der Details: ' + error.message);
                } finally {
                    document.getElementById('loadingOverlay').style.display = 'none';
                }
            };

            function showIncidentDetails(incident) {
                const modalBody = document.getElementById('modalBody');
                const modalFooter = document.getElementById('modalFooter');
                const modalTitle = document.getElementById('modalTitle');
                
                modalTitle.innerHTML = '<i class="fas fa-file-alt"></i> Vorfall Details';
                
                const date = new Date(incident.created_at).toLocaleString('de-DE');
                const week = getCalendarWeekIncident(incident.created_at);
                
                let numberDisplay = '';
                if (incident.category === 'ZfP Anlage' && incident.machine_number) {
                    numberDisplay = `<div class="detail-item"><div class="detail-label">Maschinennummer</div><div class="detail-value">${incident.machine_number}</div></div>`;
                } else if (incident.category === 'ZfP Pr√ºfung' && incident.order_number) {
                    numberDisplay = `<div class="detail-item"><div class="detail-label">Auftragsnummer</div><div class="detail-value">${incident.order_number}</div></div>`;
                }
                
                let details = `
                    <div class="detail-section">
                        <h3><i class="fas fa-info-circle"></i> Allgemeine Informationen</h3>
                        <div class="detail-grid">
                            <div class="detail-item"><div class="detail-label">Kategorie</div><div class="detail-value">${incident.category}</div></div>
                            ${numberDisplay}
                            <div class="detail-item"><div class="detail-label">Prozess</div><div class="detail-value">${incident.process}</div></div>
                            <div class="detail-item"><div class="detail-label">Segment</div><div class="detail-value">${incident.segment}</div></div>
                            <div class="detail-item"><div class="detail-label">Pr√ºfverfahren</div><div class="detail-value">${incident.inspection_method}</div></div>
                            <div class="detail-item"><div class="detail-label">Kalenderwoche</div><div class="detail-value">${week}</div></div>
                            <div class="detail-item"><div class="detail-label">Status</div><div class="detail-value"><span class="badge badge-status ${incident.status === 'closed' ? 'closed' : ''}">${incident.status === 'open' ? 'Offen' : 'Geschlossen'}</span></div></div>
                            <div class="detail-item"><div class="detail-label">Erstellt am</div><div class="detail-value">${date}</div></div>
                        </div>
                    </div>
                `;
                
                if (incident.error_type) {
                    details += `
                        <div class="detail-section">
                            <h3><i class="fas fa-exclamation-triangle"></i> Fehlerdetails</h3>
                            <div class="detail-grid">
                                <div class="detail-item"><div class="detail-label">Fehlerart</div><div class="detail-value">${incident.error_type}</div></div>
                                ${incident.type ? `<div class="detail-item"><div class="detail-label">Type / Modell</div><div class="detail-value">${incident.type}</div></div>` : ''}
                            </div>
                        </div>
                    `;
                }
                
                details += `
                    <div class="detail-section">
                        <h3><i class="fas fa-align-left"></i> Beschreibung</h3>
                        <p style="background: var(--hover-bg); padding: 20px; border-radius: 12px; font-size: 16px; line-height: 1.5;">${incident.problem_description}</p>
                    </div>
                `;
                
                if (incident.image_urls && incident.image_urls.length > 0) {
                    details += `
                        <div class="detail-section">
                            <h3><i class="fas fa-images"></i> Bilder</h3>
                            <div class="image-gallery">
                                ${incident.image_urls.map(url => `<img src="${url}" class="gallery-image" onclick="window.open('${url}', '_blank')">`).join('')}
                            </div>
                        </div>
                    `;
                }
                
                modalBody.innerHTML = details;
                
                modalFooter.innerHTML = `
                    ${incident.status === 'open' ? 
                        `<button class="btn btn-success" onclick="closeIncidentFromModal()">
                            <i class="fas fa-check-circle"></i> Erledigt
                        </button>` : 
                        `<button class="btn btn-reopen" onclick="reopenIncidentFromModal()">
                            <i class="fas fa-undo-alt"></i> Wieder √∂ffnen
                        </button>`
                    }
                    <button class="btn btn-danger" onclick="showPasswordModalForIncident('${incident.id}')">
                        <i class="fas fa-trash"></i> L√∂schen
                    </button>
                    <button class="btn" onclick="closeModal()">
                        <i class="fas fa-times"></i> Schlie√üen
                    </button>
                `;
                
                document.getElementById('detailModal').classList.add('active');
            }

            window.closeModal = function() {
                document.getElementById('detailModal').classList.remove('active');
                currentIncidentId = null;
                currentTopicId = null;
            };

            window.editIncident = async function(id) {
                document.getElementById('loadingOverlay').style.display = 'flex';
                try {
                    const { data, error } = await supabase.from('incidents').select('*').eq('id', id).single();
                    if (error) throw error;
                    
                    // Zum Vorf√§lle-Tab und Neuer-Vorfall-Tab wechseln
                    switchMainTab('vorfaelle');
                    switchSubTab('new');
                    
                    setTimeout(() => {
                        document.getElementById('editId').value = data.id;
                        document.getElementById('category').value = data.category || '';
                        updateCategoryFields();
                        setTimeout(() => {
                            if (data.category === 'ZfP Anlage') {
                                document.getElementById('machineNumber').value = data.machine_number || '';
                            } else if (data.category === 'ZfP Pr√ºfung') {
                                document.getElementById('orderNumber').value = data.order_number || '';
                                const typeInput = document.getElementById('type');
                                if (typeInput && data.type) typeInput.value = data.type;
                            }
                            document.getElementById('process').value = data.process || '';
                            document.getElementById('segment').value = data.segment || '';
                            document.getElementById('inspectionMethod').value = data.inspection_method || '';
                            document.getElementById('problemDescription').value = data.problem_description || '';
                            const errorTypeSelect = document.getElementById('errorType');
                            if (errorTypeSelect && data.error_type) errorTypeSelect.value = data.error_type;
                        }, 100);
                        
                        existingImages = data.image_urls || [];
                        const previewGrid = document.getElementById('imagePreview');
                        previewGrid.innerHTML = '';
                        existingImages.forEach(url => addImagePreview(url, true));
                        document.getElementById('submitButton').innerHTML = '<i class="fas fa-save"></i> √Ñnderungen speichern';
                        showSuccess('Vorfall kann bearbeitet werden');
                    }, 200);
                } catch (error) {
                    showError('Fehler beim Laden: ' + error.message);
                } finally {
                    document.getElementById('loadingOverlay').style.display = 'none';
                }
            };

            window.closeIncidentFromModal = function() {
                if (currentIncidentId) {
                    closeIncident(currentIncidentId);
                    closeModal();
                }
            };
            
            window.reopenIncidentFromModal = function() {
                if (currentIncidentId) {
                    reopenIncident(currentIncidentId);
                    closeModal();
                }
            };

            window.closeIncident = async function(id) {
                document.getElementById('loadingOverlay').style.display = 'flex';
                try {
                    const { error } = await supabase.from('incidents').update({ status: 'closed' }).eq('id', id);
                    if (error) throw error;
                    showSuccess('Vorfall wurde als erledigt markiert');
                    loadIncidents();
                    closeModal();
                } catch (error) {
                    showError('Fehler beim Schlie√üen: ' + error.message);
                } finally {
                    document.getElementById('loadingOverlay').style.display = 'none';
                }
            };

            window.reopenIncident = async function(id) {
                document.getElementById('loadingOverlay').style.display = 'flex';
                try {
                    const { error } = await supabase.from('incidents').update({ status: 'open' }).eq('id', id);
                    if (error) throw error;
                    showSuccess('Vorfall wurde wieder ge√∂ffnet');
                    loadIncidents();
                    closeModal();
                } catch (error) {
                    showError('Fehler beim √ñffnen: ' + error.message);
                } finally {
                    document.getElementById('loadingOverlay').style.display = 'none';
                }
            };

            // ----- THEMEN -----
            
            async function loadTopics() {
                document.getElementById('loadingOverlay').style.display = 'flex';
                
                try {
                    const { data, error } = await supabase
                        .from('topics')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (error) {
                        if (error.message.includes('relation "topics" does not exist')) {
                            document.getElementById('langfristigList').innerHTML = `
                                <div style="text-align: center; padding: 40px; color: var(--btn-danger);">
                                    <i class="fas fa-database" style="font-size: 48px; margin-bottom: 15px;"></i>
                                    <p><strong>Tabelle "topics" existiert nicht in Supabase!</strong></p>
                                    <p style="font-size: 14px;">Bitte f√ºhren Sie folgenden SQL-Befehl aus:</p>
                                    <pre style="background: var(--bg-primary); padding: 15px; border-radius: 8px; text-align: left; margin-top: 15px; font-size: 12px;">
CREATE TABLE topics (
    id BIGSERIAL PRIMARY KEY,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    horizon TEXT NOT NULL,
    category TEXT NOT NULL,
    title TEXT NOT NULL,
    process TEXT,
    description TEXT NOT NULL,
    measures TEXT,
    status TEXT DEFAULT 'open'
);
ALTER TABLE topics DISABLE ROW LEVEL SECURITY;
                                    </pre>
                                </div>
                            `;
                            document.getElementById('kurzfristigList').innerHTML = '';
                            document.getElementById('loadingOverlay').style.display = 'none';
                            return;
                        }
                        throw error;
                    }
                    
                    allTopics = data || [];
                    
                    if (allTopics.length === 0) {
                        const demoTopics = [
                            { horizon: 'langfristig', category: 'Digitalisierung', title: 'Einf√ºhrung MDE', process: 'alle', description: 'Digitale Maschinendatenerfassung', measures: 'Lastenheft erstellen', status: 'open', created_at: new Date().toISOString() },
                            { horizon: 'langfristig', category: 'Pr√ºfprozessoptimierung', title: 'Automatisierung UT', process: 'Laufbahn', description: 'Ultraschall automatisieren', measures: 'Angebote einholen', status: 'open', created_at: new Date().toISOString() },
                            { horizon: 'kurzfristig', category: 'ZfP Anlage', title: 'MT-Anlage kalibrieren', process: 'Seitenschleifen', description: 'J√§hrliche Kalibrierung', measures: 'Servicetermin', status: 'open', created_at: new Date().toISOString() },
                            { horizon: 'kurzfristig', category: 'ZfP Pr√ºfung', title: 'Nacharbeit Chargenpr√ºfung', process: 'Centerless', description: 'Rissverdacht bei Charge X', measures: 'Nachpr√ºfung', status: 'closed', created_at: new Date().toISOString() },
                        ];
                        
                        for (const topic of demoTopics) {
                            await supabase.from('topics').insert([topic]);
                        }
                        
                        const { data: newData } = await supabase.from('topics').select('*').order('created_at', { ascending: false });
                        allTopics = newData || [];
                    }
                    
                    filterLongTerm();
                } catch (error) {
                    console.error('Fehler beim Laden der Themen:', error);
                    document.getElementById('langfristigList').innerHTML = `
                        <div style="text-align: center; padding: 50px; color: var(--btn-danger);">
                            <i class="fas fa-exclamation-circle" style="font-size: 48px; margin-bottom: 15px;"></i>
                            <p>Fehler beim Laden: ${error.message}</p>
                        </div>
                    `;
                } finally {
                    document.getElementById('loadingOverlay').style.display = 'none';
                }
            }

            function getCalendarWeek(dateStr) {
                const d = new Date(dateStr);
                d.setHours(0,0,0,0);
                d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
                const week1 = new Date(d.getFullYear(), 0, 4);
                const weekNum = 1 + Math.round(((d - week1) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
                return `KW ${weekNum} - ${d.getFullYear()}`;
            }

            function groupTopicsByWeek(items) {
                const groups = {};
                items.forEach(t => {
                    const wk = getCalendarWeek(t.created_at);
                    if (!groups[wk]) groups[wk] = [];
                    groups[wk].push(t);
                });
                return Object.keys(groups).sort((a,b) => {
                    const aNum = parseInt(a.split(' ')[1]) + (parseInt(a.split(' - ')[1])*100);
                    const bNum = parseInt(b.split(' ')[1]) + (parseInt(b.split(' - ')[1])*100);
                    return bNum - aNum;
                }).reduce((acc, key) => { acc[key] = groups[key]; return acc; }, {});
            }

            function renderThemeList(horizon, containerId, filterCat='', filterStatus='') {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                let filtered = allTopics.filter(t => t.horizon === horizon);
                if (filterCat) filtered = filtered.filter(t => t.category === filterCat);
                if (filterStatus) filtered = filtered.filter(t => t.status === filterStatus);

                if (filtered.length === 0) {
                    container.innerHTML = `<div style="padding:40px; text-align:center; color:var(--text-secondary);"><i class="fas fa-folder-open fa-3x"></i><p>Keine Themen</p></div>`;
                    return;
                }

                const grouped = groupTopicsByWeek(filtered);
                let html = '';
                for (let week in grouped) {
                    html += `<div class="kw-group"><div class="kw-header"><i class="fas fa-calendar-week"></i> ${week} <span class="kw-count">${grouped[week].length}</span></div><div class="incident-grid">`;
                    grouped[week].forEach(t => {
                        const statusClass = t.status === 'closed' ? 'closed' : '';
                        const statusIcon = t.status === 'open' ? 'fa-hourglass-half' : 'fa-check-circle';
                        const horizonIcon = t.horizon === 'langfristig' ? 'fa-calendar-alt' : 'fa-hourglass-half';
                        const horizonBadgeClass = t.horizon === 'langfristig' ? 'badge-long' : 'badge-short';

                        let catClass = 'badge-category';
                        if (t.category.includes('Digitalisierung')) catClass = 'badge-digital';
                        else if (t.category.includes('Pr√ºfprozessoptimierung')) catClass = 'badge-opt';
                        else catClass = 'badge-category';

                        html += `
                            <div class="incident-card">
                                <div class="card-header">
                                    <div class="card-badges">
                                        <span class="badge ${horizonBadgeClass}"><i class="fas ${horizonIcon}"></i> ${t.horizon === 'langfristig' ? 'Langfristig' : 'Kurzfristig'}</span>
                                        <span class="badge ${catClass}"><i class="fas fa-tag"></i> ${t.category}</span>
                                        <span class="badge badge-status ${statusClass}"><i class="fas ${statusIcon}"></i> ${t.status==='open'?'Offen':'Geschlossen'}</span>
                                    </div>
                                    <div class="card-date"><i class="far fa-calendar-alt"></i> ${new Date(t.created_at).toLocaleDateString('de-DE')}</div>
                                </div>
                                <div class="card-content" onclick="openTopic('${t.id}')">
                                    <div class="info-row"><span class="info-label"><i class="fas fa-heading"></i> Titel:</span><span class="info-value">${t.title}</span></div>
                                    ${t.process ? `<div class="info-row"><span class="info-label">Prozess:</span><span class="info-value">${t.process}</span></div>` : ''}
                                    <div class="info-row"><span class="info-label">Beschreibung:</span><span class="info-value">${t.description.substring(0,70)}...</span></div>
                                    ${t.measures ? `<div class="info-row"><span class="info-label">Ma√ünahmen:</span><span class="info-value">${t.measures.substring(0,50)}...</span></div>` : ''}
                                </div>
                                <div class="card-actions">
                                    <button class="action-button view" onclick="openTopic('${t.id}')"><i class="fas fa-eye"></i> Details</button>
                                    <button class="action-button edit" onclick="editTopic('${t.id}')"><i class="fas fa-edit"></i> Edit</button>
                                    ${t.status === 'open' ? 
                                        `<button class="action-button close" onclick="closeTopic('${t.id}')"><i class="fas fa-check-circle"></i> Erledigt</button>` : 
                                        `<button class="action-button reopen" onclick="reopenTopic('${t.id}')"><i class="fas fa-undo-alt"></i> Wieder √∂ffnen</button>`}
                                    <button class="action-button delete" onclick="showPasswordModalForTopic('${t.id}')"><i class="fas fa-trash"></i> L√∂schen</button>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div></div>';
                }
                container.innerHTML = html;
            }

            window.filterLongTerm = function() {
                const cat = document.getElementById('filterLangCategory').value;
                const stat = document.getElementById('filterLangStatus').value;
                renderThemeList('langfristig', 'langfristigList', cat, stat);
            };
            
            window.filterShortTerm = function() {
                const cat = document.getElementById('filterShortCategory').value;
                const stat = document.getElementById('filterShortStatus').value;
                renderThemeList('kurzfristig', 'kurzfristigList', cat, stat);
            };

            window.saveTopic = async function() {
                const horizon = document.getElementById('horizon').value;
                const category = document.getElementById('themeCategory').value;
                const title = document.getElementById('title').value.trim();
                const process = document.getElementById('themeProcess').value.trim();
                const description = document.getElementById('description').value.trim();
                const measures = document.getElementById('measures').value.trim();
                const editId = document.getElementById('themeEditId').value;

                if (!horizon || !category || !title || !description) {
                    document.getElementById('themeErrorText').innerText = 'Bitte alle Pflichtfelder ausf√ºllen';
                    document.getElementById('themeErrorMessage').style.display = 'flex';
                    setTimeout(() => document.getElementById('themeErrorMessage').style.display = 'none', 3000);
                    return;
                }

                document.getElementById('loadingOverlay').style.display = 'flex';
                
                try {
                    const topicData = {
                        horizon,
                        category,
                        title,
                        process: process || null,
                        description,
                        measures: measures || null
                    };
                    
                    if (editId) {
                        const { error } = await supabase
                            .from('topics')
                            .update(topicData)
                            .eq('id', editId);
                        
                        if (error) throw error;
                    } else {
                        topicData.status = 'open';
                        topicData.created_at = new Date().toISOString();
                        
                        const { error } = await supabase
                            .from('topics')
                            .insert([topicData]);
                        
                        if (error) throw error;
                    }
                    
                    document.getElementById('loadingOverlay').style.display = 'none';
                    document.getElementById('themeSuccessMessage').style.display = 'flex';
                    setTimeout(() => document.getElementById('themeSuccessMessage').style.display = 'none', 2000);
                    
                    document.getElementById('topicForm').reset();
                    document.getElementById('themeEditId').value = '';
                    
                    await loadTopics();
                    
                    if (horizon === 'langfristig') switchThemesTab('langfristig');
                    else switchThemesTab('kurzfristig');
                    
                } catch (error) {
                    console.error('Fehler beim Speichern:', error);
                    document.getElementById('themeErrorText').innerText = 'Fehler: ' + error.message;
                    document.getElementById('themeErrorMessage').style.display = 'flex';
                    document.getElementById('loadingOverlay').style.display = 'none';
                }
            };

            window.openTopic = async function(id) {
                document.getElementById('loadingOverlay').style.display = 'flex';
                try {
                    const { data, error } = await supabase.from('topics').select('*').eq('id', id).single();
                    if (error) throw error;
                    currentTopicId = id;
                    showTopicDetails(data);
                } catch (error) {
                    showError('Fehler beim Laden der Details: ' + error.message);
                } finally {
                    document.getElementById('loadingOverlay').style.display = 'none';
                }
            };

            function showTopicDetails(topic) {
                const modalBody = document.getElementById('modalBody');
                const modalFooter = document.getElementById('modalFooter');
                const modalTitle = document.getElementById('modalTitle');
                
                modalTitle.innerHTML = '<i class="fas fa-tasks"></i> Thema Details';
                
                const date = new Date(topic.created_at).toLocaleString('de-DE');
                const week = getCalendarWeek(topic.created_at);
                
                let horizonClass = topic.horizon === 'langfristig' ? 'badge-long' : 'badge-short';
                let horizonText = topic.horizon === 'langfristig' ? 'Langfristig' : 'Kurzfristig';
                
                let catClass = 'badge-category';
                if (topic.category.includes('Digitalisierung')) catClass = 'badge-digital';
                else if (topic.category.includes('Pr√ºfprozessoptimierung')) catClass = 'badge-opt';
                
                let details = `
                    <div class="detail-section">
                        <h3><i class="fas fa-info-circle"></i> Allgemeine Informationen</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <div class="detail-label">Horizont</div>
                                <div class="detail-value"><span class="badge ${horizonClass}">${horizonText}</span></div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Kategorie</div>
                                <div class="detail-value"><span class="badge ${catClass}">${topic.category}</span></div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Titel</div>
                                <div class="detail-value">${topic.title}</div>
                            </div>
                            ${topic.process ? `
                            <div class="detail-item">
                                <div class="detail-label">Prozess</div>
                                <div class="detail-value">${topic.process}</div>
                            </div>
                            ` : ''}
                            <div class="detail-item">
                                <div class="detail-label">Kalenderwoche</div>
                                <div class="detail-value">${week}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Status</div>
                                <div class="detail-value"><span class="badge badge-status ${topic.status === 'closed' ? 'closed' : ''}">${topic.status === 'open' ? 'Offen' : 'Geschlossen'}</span></div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Erstellt am</div>
                                <div class="detail-value">${date}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3><i class="fas fa-align-left"></i> Beschreibung</h3>
                        <p style="background: var(--hover-bg); padding: 20px; border-radius: 12px; font-size: 16px; line-height: 1.5;">${topic.description}</p>
                    </div>
                `;
                
                if (topic.measures) {
                    details += `
                        <div class="detail-section">
                            <h3><i class="fas fa-tasks"></i> Ma√ünahmen / n√§chste Schritte</h3>
                            <p style="background: var(--hover-bg); padding: 20px; border-radius: 12px; font-size: 16px; line-height: 1.5;">${topic.measures}</p>
                        </div>
                    `;
                }
                
                modalBody.innerHTML = details;
                
                modalFooter.innerHTML = `
                    ${topic.status === 'open' ? 
                        `<button class="btn btn-success" onclick="closeTopicFromModal()">
                            <i class="fas fa-check-circle"></i> Erledigt
                        </button>` : 
                        `<button class="btn btn-reopen" onclick="reopenTopicFromModal()">
                            <i class="fas fa-undo-alt"></i> Wieder √∂ffnen
                        </button>`
                    }
                    <button class="btn btn-danger" onclick="showPasswordModalForTopic('${topic.id}')">
                        <i class="fas fa-trash"></i> L√∂schen
                    </button>
                    <button class="btn" onclick="closeModal()">
                        <i class="fas fa-times"></i> Schlie√üen
                    </button>
                `;
                
                document.getElementById('detailModal').classList.add('active');
            }

            window.editTopic = function(id) {
                const t = allTopics.find(t => t.id == id);
                if (!t) return;
                
                // Zum Themen-Tab und Neues-Thema-Tab wechseln
                switchMainTab('themen');
                switchThemesTab('neu');
                
                setTimeout(() => {
                    document.getElementById('themeEditId').value = t.id;
                    document.getElementById('horizon').value = t.horizon;
                    document.getElementById('themeCategory').value = t.category;
                    document.getElementById('title').value = t.title;
                    document.getElementById('themeProcess').value = t.process || '';
                    document.getElementById('description').value = t.description;
                    document.getElementById('measures').value = t.measures || '';
                }, 100);
            };

            window.closeTopicFromModal = function() {
                if (currentTopicId) {
                    closeTopic(currentTopicId);
                    closeModal();
                }
            };

            window.closeTopic = async function(id) {
                document.getElementById('loadingOverlay').style.display = 'flex';
                try {
                    const { error } = await supabase
                        .from('topics')
                        .update({ status: 'closed' })
                        .eq('id', id);
                    
                    if (error) throw error;
                    
                    await loadTopics();
                    showSuccess('Thema erledigt');
                    closeModal();
                } catch (error) {
                    showError('Fehler: ' + error.message);
                } finally {
                    document.getElementById('loadingOverlay').style.display = 'none';
                }
            };

            window.reopenTopicFromModal = function() {
                if (currentTopicId) {
                    reopenTopic(currentTopicId);
                    closeModal();
                }
            };
            
            window.reopenTopic = async function(id) {
                document.getElementById('loadingOverlay').style.display = 'flex';
                try {
                    const { error } = await supabase
                        .from('topics')
                        .update({ status: 'open' })
                        .eq('id', id);
                    
                    if (error) throw error;
                    
                    await loadTopics();
                    showSuccess('Thema wieder ge√∂ffnet');
                    closeModal();
                } catch (error) {
                    showError('Fehler: ' + error.message);
                } finally {
                    document.getElementById('loadingOverlay').style.display = 'none';
                }
            };

            // ----- PASSWORT & L√ñSCHEN -----
            
            window.showPasswordModalForIncident = function(id) {
                console.log('L√∂schen f√ºr Vorfall:', id);
                currentIncidentId = id;
                currentTopicId = null;
                pendingAction = 'deleteIncident';
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordError').classList.remove('show');
                document.getElementById('passwordModal').classList.add('active');
            };

            window.showPasswordModalForTopic = function(id) {
                console.log('L√∂schen f√ºr Thema:', id);
                currentTopicId = id;
                currentIncidentId = null;
                pendingAction = 'deleteTopic';
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordError').classList.remove('show');
                document.getElementById('passwordModal').classList.add('active');
            };

            window.closePasswordModal = function() {
                document.getElementById('passwordModal').classList.remove('active');
            };

            window.checkPasswordAndDelete = async function() {
                const password = document.getElementById('passwordInput').value;
                
                if (password !== SUPERVIOR_PASSWORD) {
                    document.getElementById('passwordError').classList.add('show');
                    return;
                }
                
                // Passwort korrekt - Modal schlie√üen
                closePasswordModal();
                
                // Loading anzeigen
                document.getElementById('loadingOverlay').style.display = 'flex';
                
                try {
                    if (pendingAction === 'deleteIncident' && currentIncidentId) {
                        console.log('L√∂sche Vorfall mit ID:', currentIncidentId);
                        
                        // Erst die Bilder laden
                        const { data: incident, error: fetchError } = await supabase
                            .from('incidents')
                            .select('*')
                            .eq('id', currentIncidentId)
                            .single();
                        
                        if (fetchError) {
                            console.error('Fehler beim Laden des Vorfalls:', fetchError);
                            throw fetchError;
                        }
                        
                        // Bilder l√∂schen (falls vorhanden)
                        if (incident && incident.image_urls && incident.image_urls.length > 0) {
                            for (const url of incident.image_urls) {
                                try {
                                    const fileName = url.split('/').pop();
                                    console.log('L√∂sche Bild:', fileName);
                                    await supabase.storage.from('incident_images').remove([fileName]);
                                } catch (e) {
                                    console.error('Fehler beim L√∂schen eines Bildes:', e);
                                    // Weiter machen, auch wenn Bild nicht gel√∂scht werden kann
                                }
                            }
                        }
                        
                        // Dann den Vorfall l√∂schen
                        const { error: deleteError } = await supabase
                            .from('incidents')
                            .delete()
                            .eq('id', currentIncidentId);
                        
                        if (deleteError) {
                            console.error('Fehler beim L√∂schen des Vorfalls:', deleteError);
                            throw deleteError;
                        }
                        
                        console.log('Vorfall erfolgreich gel√∂scht');
                        showSuccess('Vorfall gel√∂scht');
                        
                        // Modal schlie√üen und Liste neu laden
                        closeModal();
                        await loadIncidents();
                        
                    } else if (pendingAction === 'deleteTopic' && currentTopicId) {
                        console.log('L√∂sche Thema mit ID:', currentTopicId);
                        
                        const { error } = await supabase
                            .from('topics')
                            .delete()
                            .eq('id', currentTopicId);
                        
                        if (error) {
                            console.error('Fehler beim L√∂schen des Themas:', error);
                            throw error;
                        }
                        
                        console.log('Thema erfolgreich gel√∂scht');
                        showSuccess('Thema gel√∂scht');
                        
                        // Modal schlie√üen und Liste neu laden
                        closeModal();
                        await loadTopics();
                    }
                } catch (error) {
                    console.error('Fehler beim L√∂schen:', error);
                    showError('Fehler beim L√∂schen: ' + error.message);
                } finally {
                    document.getElementById('loadingOverlay').style.display = 'none';
                    pendingAction = null;
                    currentIncidentId = null;
                    currentTopicId = null;
                }
            };

            // Initialisierung - Liste ist jetzt standardm√§√üig aktiv
            document.addEventListener('DOMContentLoaded', function() {
                document.getElementById('category')?.addEventListener('change', updateCategoryFields);
                updateCategoryFields();
                loadIncidents(); // L√§dt die Liste automatisch
            });
        })();
    </script>
</body>
</html>
